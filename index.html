<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VercelMuvi - Tu Plataforma de Streaming</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos generales oscuros para una apariencia moderna y elegante */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Blue Gray */
        }
        /* Clase para el reproductor de video (Aspect Ratio 16:9) */
        .aspect-video-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
            height: 0;
            overflow: hidden;
            background-color: #000;
        }
        .aspect-video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="min-h-screen text-white">

    <header class="bg-gray-900 shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-extrabold text-indigo-400 mb-4 sm:mb-0 cursor-pointer" id="nav-home">
                VercelMuvi
            </h1>

            <div class="flex items-center space-x-4 w-full sm:w-auto">

                <div class="relative flex-grow">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Buscar series o películas..." 
                        class="w-full sm:w-64 bg-gray-800 text-white rounded-full py-2 px-4 pl-10 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
                    >
                    <button id="search-button" class="absolute left-0 top-1/2 transform -translate-y-1/2 ml-3 text-gray-400 hover:text-indigo-400 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <button 
                    id="nav-about" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full transition duration-150 shadow-md whitespace-nowrap"
                >
                    Acerca de
                </button>
            </div>
        </div>
    </header>

    <div class="bg-gray-800 p-2 border-b border-gray-700">
        <div class="container mx-auto px-4">
            <span class="text-sm text-gray-400">VercelMuvi / <span id="current-title" class="text-indigo-300 font-medium">Inicio</span></span>
        </div>
    </div>

    <main id="content" class="min-h-[70vh]">
        </main>

    <footer class="bg-gray-900 p-4 text-center text-gray-500 mt-8">
        <p>&copy; 2025 VercelMuvi. Plataforma de contenido organizado.</p>
    </footer>

    <script>
        // --- CONFIGURACIÓN Y DATOS ---
        // URL de tu archivo JSON
        // Apunta a 'data.json' si está en la misma carpeta.
        // Si lo subes a una URL pública, podrías usar esa URL aquí.
        const DATA_URL = 'data.json'; 

        // Información para la página "Acerca de"
        const WHATSAPP_NUMBER = '573001234567'; // Reemplaza con tu número
        const ADMIN_EMAIL = 'contacto@vercelmuvi.com'; // Reemplaza con tu correo

        // Variables de estado
        let groupedData = []; // Datos agrupados por la URL de la portada

        // --- LÓGICA DE PROCESAMIENTO DE DATOS ---

        // Función para manejar fetch con reintentos (mejorando la robustez de la conexión)
        async function fetchWithRetry(url, retries = 3) {
            let lastError = null; // Variable para almacenar el último error o estado
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return response;
                    }
                    // Si falla por status (ej: 404, 500)
                    lastError = `Status ${response.status}: La URL devolvió un error.`;
                    console.warn(`[VercelMuvi] Intento ${i + 1} fallido con status ${response.status}. Reintentando...`);
                } catch (error) {
                    // Si falla por error de red (ej: CORS, DNS)
                    lastError = `Error de red/seguridad: ${error.message}`;
                    console.warn(`[VercelMuvi] Intento ${i + 1} fallido por error de red:`, error);
                }
                // Espera exponencial (1s, 2s, 4s) antes de reintentar
                if (i < retries - 1) {
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
            throw new Error(`Fallo al cargar la URL después de ${retries} intentos. Último error: ${lastError || 'Desconocido.'}`);
        }

        // Función para validar y preparar los datos JSON
        function processJSONData(jsonData) {
            console.log("--- Diagnóstico JSON de VercelMuvi ---");
            if (!Array.isArray(jsonData)) {
                console.error("[JSON ERROR CRÍTICO] El archivo JSON no es un array de objetos. Debe empezar y terminar con corchetes `[]`.");
                return [];
            }

            const processedData = [];
            jsonData.forEach((item, index) => {
                // Aseguramos que existan las propiedades clave y las limpiamos
                const url = item.url ? String(item.url).trim() : '';
                const nombre = item.nombre ? String(item.nombre).trim() : '';
                const embed = item.embed ? String(item.embed).trim() : '';

                if (url && nombre && embed) {
                    processedData.push({
                        url: url,
                        nombre: nombre,
                        embed: embed,
                        portada: url // Mapeamos 'url' a 'portada' para compatibilidad con la lógica existente
                    });
                } else {
                    console.warn(`[JSON Diagnóstico] Objeto descartado en índice ${index} (datos incompletos en url, nombre o embed):`, item);
                }
            });
            console.log(`[JSON Diagnóstico] Total de objetos válidos procesados: ${processedData.length}`);
            console.log("-------------------------------------");
            return processedData;
        }


        // Función para agrupar las filas por la URL de la portada
        // ¡Esta función es la clave para agrupar capítulos bajo la misma imagen!
        function groupData(data) {
            const groups = {};

            data.forEach(item => {
                // Usamos item.portada que es item.url renombrado en processJSONData
                const key = item.portada; 

                if (!groups[key]) {
                    groups[key] = {
                        portada: key,
                        // El título principal se toma de la primera parte del nombre (antes del ' - ')
                        title: item.nombre.split(' - ')[0] || item.nombre, 
                        items: []
                    };
                }
                groups[key].items.push(item);
            });

            // Ordena los ítems dentro de cada grupo por nombre y los grupos por título
            for (const key in groups) {
                groups[key].items.sort((a, b) => a.nombre.localeCompare(b.nombre));
            }

            return Object.values(groups).sort((a, b) => a.title.localeCompare(b.title));
        }

        // --- Herramienta de Diagnóstico Manual para Consola (para JSON) ---
        window.__debugCheckJSON = function() { // Hacemos la función global
            console.log("--- INICIO DE DIAGNÓSTICO MANUAL DE JSON ---");
            console.log(`Intentando acceder a la URL: ${DATA_URL}`);
            fetch(DATA_URL)
                .then(response => {
                    if (!response.ok) {
                        console.error(`ERROR: Fallo al cargar el JSON. Código de estado: ${response.status}. Revisa si la URL es correcta.`);
                        return null;
                    }
                    return response.json(); // Intentamos parsear como JSON
                })
                .then(jsonData => {
                    if (!jsonData) return;

                    console.log("1. DATOS JSON ENCONTRADOS:", jsonData);

                    if (!Array.isArray(jsonData)) {
                        console.error("2. ❌ ERROR CRÍTICO DE FORMATO: El JSON no es un array de objetos. Debe empezar y terminar con corchetes `[]`.");
                        return;
                    }

                    const sampleItems = jsonData.slice(0, 5); // Tomamos una muestra
                    if (sampleItems.length === 0) {
                        console.warn("2. ADVERTENCIA: JSON vacío. No hay objetos de datos.");
                    } else {
                        console.log("\n3. PRIMEROS OBJETOS DE DATOS (PARA INSPECCIÓN DE FORMATO):");
                        sampleItems.forEach((item, index) => {
                            console.log(`    Objeto ${index + 1}:`);
                            console.log(`        url: ${item.url || '❌ Falta o es vacío'}`);
                            console.log(`        nombre: ${item.nombre || '❌ Falta o es vacío'}`);
                            console.log(`        embed: ${item.embed || '❌ Falta o es vacío'}`);
                            if (!item.url || !item.nombre || !item.embed) {
                                console.error(`        ¡ERROR: Este objeto tiene campos clave faltantes o vacíos!`);
                            }
                        });
                        console.log("2. ✅ FORMATO JSON OK: Se detectaron las propiedades 'url', 'nombre', 'embed' en los objetos de muestra.");
                    }
                    console.log("--- FIN DE DIAGNÓSTICO MANUAL. ---");
                })
                .catch(error => {
                    console.error("ERROR DE RED DURANTE EL DIAGNÓSTICO O JSON INVÁLIDO:", error);
                });
        };
        // --- FIN de Herramienta de Diagnóstico ---


        // Carga y procesa los datos (ahora desde JSON)
        async function loadData() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center p-10 text-lg text-indigo-400">
                    <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Cargando contenido de VercelMuvi...
                    <p class="text-sm text-gray-400 mt-2">Revisa la consola (F12) para diagnósticos detallados.</p>
                </div>`;

            try {
                // Carga el JSON
                const response = await fetchWithRetry(DATA_URL);
                const jsonData = await response.json(); // ¡IMPORTANTE: Usamos .json() para JSON!

                const rawData = processJSONData(jsonData); // Nueva función para procesar JSON

                groupedData = groupData(rawData); // Aquí es donde la magia de agrupación ocurre

                if (groupedData.length === 0) {
                    content.innerHTML = `<div class="text-center p-10 text-red-400">
                        <h2 class="text-xl font-bold mb-4">¡Falla de Carga de Datos!</h2>
                        <p>No se encontraron datos válidos. El error es casi seguro un problema con el formato del JSON o la existencia de las propiedades clave (url, nombre, embed).</p>
                        <p class="text-white mt-4 font-bold text-lg">
                            Para diagnosticar el error: <br>
                            1. Abre la Consola del navegador (F12) <br>
                            2. Escribe: <code class="bg-gray-700 p-1 rounded">__debugCheckJSON()</code> y presiona Enter.
                        </p>
                        <ul class="list-disc list-inside text-left mx-auto max-w-sm mt-4 text-gray-300">
                            <li>Recuerda: El JSON debe ser un array de objetos, y cada objeto debe tener las propiedades <b>"url", "nombre", "embed"</b>.</li>
                            <li>Asegúrate de que el archivo JSON esté en la ruta correcta o la URL sea accesible.</li>
                        </ul>
                    </div>`;
                    return;
                }

                renderHome(); // Muestra la vista de inicio con los datos agrupados

            } catch (error) {
                console.error('[ERROR FATAL VercelMuvi] La carga de datos JSON falló completamente:', error);
                content.innerHTML = `<div class="text-center p-10 text-red-400">
                    <h2 class="text-xl font-bold mb-4">Error de Conexión/Formato JSON</h2>
                    <p>Fallo al cargar la URL o al procesar el archivo JSON después de varios intentos.</p>
                    <p class="text-sm text-gray-400 mt-2">Detalles: ${error.message}</p>
                    <p class="text-white mt-4 font-bold text-lg">
                        Para diagnosticar el error: <br>
                        1. Abre la Consola del navegador (F12) <br>
                        2. Escribe: <code class="bg-gray-700 p-1 rounded">__debugCheckJSON()</code> y presiona Enter.
                    </p>
                </div>`;
            }
        }

        // --- FUNCIONES DE RENDERING (VISTAS) ---
        // Estas funciones están prácticamente intactas porque la estructura de `groupedData` no ha cambiado.

        function clearContent() {
            document.getElementById('content').innerHTML = '';
        }

        // 1. Vista de Portadas (Home)
        window.renderHome = function(filterText = '') { 
            clearContent();
            document.getElementById('current-title').textContent = 'Inicio';

            const content = document.getElementById('content');
            const lowerCaseFilter = filterText.toLowerCase();

            // Filtrar grupos por el título principal o por el nombre de alguna de sus partes
            const filteredGroups = groupedData.filter(group => 
                group.title.toLowerCase().includes(lowerCaseFilter) || 
                group.items.some(item => item.nombre.toLowerCase().includes(lowerCaseFilter))
            );

            const cardsHtml = filteredGroups.map(group => {
                const fallbackSrc = 'https://placehold.co/250x375/312e81/ffffff?text=VercelMuvi';

                return `
                    <div 
                        class="bg-gray-800 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 ease-in-out cursor-pointer transform hover:-translate-y-1 overflow-hidden"
                        onclick="renderDetails('${group.portada.replace(/'/g, "\\'")}')"
                    >
                        <div class="relative w-full aspect-[2/3] bg-gray-900">
                            <img 
                                src="${group.portada}" 
                                alt="Portada de ${group.title}" 
                                class="w-full h-full object-cover transition duration-500 ease-in-out hover:opacity-75"
                                onerror="this.onerror=null; this.src='${fallbackSrc}';"
                            />
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <div class="absolute bottom-0 left-0 p-4">
                                <h3 class="text-xl font-bold text-white leading-tight">${group.title}</h3>
                                <p class="text-sm text-indigo-300">${group.items.length} ${group.items.length > 1 ? 'partes/caps' : 'parte/cap'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            content.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <h2 class="text-3xl font-extrabold text-white mb-6">Contenido Agrupado</h2>
                    ${filteredGroups.length === 0 ? 
                        `<p class="text-white text-lg mt-10 text-center">No se encontraron resultados para "${filterText}".</p>` : 
                        `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                            ${cardsHtml}
                        </div>`
                    }
                </div>
            `;
            document.getElementById('search-input').value = filterText;
        }

        // 2. Vista de Detalles (Capítulos/Partes)
        window.renderDetails = function(portadaKey) { 
            clearContent();
            const content = document.getElementById('content');
            const group = groupedData.find(g => g.portada === portadaKey);

            if (!group) {
                renderHome(); 
                return;
            }

            document.getElementById('current-title').textContent = group.title;

            const partsList = group.items.map(item => `
                <li 
                    class="p-4 border-b border-gray-700 last:border-b-0 hover:bg-indigo-900/20 transition duration-150 cursor-pointer rounded-lg"
                    onclick="renderPlayer('${item.embed.replace(/'/g, "\\'")}', '${item.nombre.replace(/'/g, "\\'")}')"
                >
                    <span class="font-semibold text-white text-lg">${item.nombre}</span>
                    <span class="text-sm text-gray-400 block">Clic para ver</span>
                </li>
            `).join('');

            const fallbackSrc = 'https://placehold.co/300x450/312e81/ffffff?text=VercelMuvi';

            content.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <button onclick="navigateTo('home')" class="text-indigo-400 hover:text-indigo-300 mb-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Volver a Portadas
                    </button>

                    <div class="md:flex bg-gray-800/50 rounded-xl p-6 shadow-2xl">
                        <div class="md:w-1/3 flex justify-center mb-6 md:mb-0">
                            <img 
                                src="${group.portada}" 
                                alt="Portada de ${group.title}" 
                                class="rounded-xl w-64 h-auto object-cover shadow-2xl"
                                onerror="this.onerror=null; this.src='${fallbackSrc}';"
                            />
                        </div>
                        <div class="md:w-2/3 md:pl-8">
                            <h1 class="text-4xl font-extrabold text-white mb-4">${group.title}</h1>
                            <p class="text-indigo-400 text-lg mb-6">${group.items.length} Partes o Capítulos Disponibles</p>

                            <div class="bg-gray-900 rounded-lg shadow-inner mt-4 max-h-96 overflow-y-auto">
                                <ul class="divide-y divide-gray-700">
                                    ${partsList}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            window.history.pushState({ view: 'details', key: portadaKey }, group.title, `#details/${encodeURIComponent(portadaKey)}`);
        }

        // 3. Vista del Reproductor de Video
        window.renderPlayer = function(embedUrl, title) { 
            clearContent();
            const content = document.getElementById('content');

            document.getElementById('current-title').textContent = title;

            let videoSource = embedUrl;

            if (embedUrl.toLowerCase().startsWith('<iframe')) {
                const match = embedUrl.match(/src=["'](.*?)["']/i);
                if (match && match[1]) {
                    videoSource = match[1];
                    console.log("[Reproductor] URL extraída correctamente de un código iframe.");
                } else {
                    console.error("[Reproductor] El código de embed era un iframe pero no se pudo extraer la URL 'src'. Usando el valor original.");
                    videoSource = embedUrl; 
                }
            } else {
                 console.log("[Reproductor] Usando URL de embed directamente.");
            }

            content.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <button onclick="history.back()" class="text-indigo-400 hover:text-indigo-300 mb-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Volver a la Lista
                    </button>

                    <h1 class="text-3xl font-extrabold text-white mb-4">${title}</h1>

                    <div class="aspect-video-wrapper rounded-xl shadow-2xl"> 
                        <iframe 
                            src="${videoSource}" 
                            frameborder="0" 
                            allowfullscreen 
                            title="Reproductor de ${title}"
                        ></iframe>
                    </div>

                    <p class="text-gray-400 mt-4 text-center">Si el reproductor no carga, verifica tu conexión o el enlace de origen.</p>
                </div>
            `;
            window.history.pushState({ view: 'player', url: embedUrl }, title, `#player/${encodeURIComponent(title)}`);
        }


        // 4. Vista "Acerca de"
        window.renderAbout = function() { 
            clearContent();
            document.getElementById('current-title').textContent = 'Acerca de';

            const content = document.getElementById('content');
            const whatsappLink = `https://wa.me/${WHATSAPP_NUMBER}?text=Hola,%20me%20gustaría%20solicitar%20la%20siguiente%20serie%20o%20película...`;

            content.innerHTML = `
                <div class="container mx-auto px-4 py-8 max-w-2xl">
                    <div class="bg-gray-800 rounded-xl p-8 shadow-2xl">
                        <h1 class="text-4xl font-extrabold text-indigo-400 mb-6">Acerca de VercelMuvi</h1>

                        <p class="text-gray-300 mb-8">
                            VercelMuvi es una plataforma moderna, elegante y organizada dedicada a ofrecerte el mejor contenido de series y películas agrupado de forma intuitiva por su portada. Nuestro objetivo es que encuentres lo que buscas rápidamente.
                        </p>

                        <div class="space-y-4 mb-10 border-t border-gray-700 pt-6">
                            <h2 class="text-2xl font-bold text-white">Información de Contacto</h2>
                            <div class="flex items-center text-gray-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                                <span class="font-medium">Correo del Gestor:</span> <a href="mailto:${ADMIN_EMAIL}" class="ml-2 text-indigo-300 hover:text-indigo-200 transition">${ADMIN_EMAIL}</a>
                            </div>
                            <div class="flex items-center text-gray-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.772-1.549a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                </svg>
                                <span class="font-medium">Número de Teléfono:</span> <span class="ml-2 text-white">${WHATSAPP_NUMBER}</span>
                            </div>
                        </div>

                        <a 
                            href="${whatsappLink}" 
                            target="_blank" 
                            class="mt-8 w-full flex items-center justify-center px-8 py-4 border border-transparent text-lg font-bold rounded-full shadow-lg text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-700/50 transition duration-150 transform hover:scale-[1.02]"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="mr-3">
                                <path d="M12.001 2c-5.522 0-10 4.477-10 10 0 3.033 1.34 5.762 3.493 7.61l-.678 2.017 2.083-.65 2.158.749 4.945-4.832c3.486-1.743 5.495-5.32 5.01-9.176-.485-3.856-3.882-6.843-7.893-6.843zm4.562 10.98c-.18.12-.392.18-.636.18h-.001c-.244 0-.466-.06-.677-.18s-.36-.28-.54-.42c-.18-.14-.36-.33-.48-.54s-.22-.48-.22-.72c0-.24.08-.48.22-.72s.3-.41.51-.59c.21-.18.42-.31.64-.39.22-.08.48-.12.78-.12h.001c.3 0 .56.04.78.12s.39.21.57.39c.18.18.3.37.38.6s.12.42.12.72c0 .24-.04.48-.12.72s-.21.46-.39.63z" fill="#FFF"/>
                            </svg>
                            Pedir Serie o Película
                        </a>
                    </div>
                </div>
            `;
        }

        // --- NAVEGACIÓN Y CONTROL DE ESTADO ---

        window.navigateTo = function(view, data = '') { 
            if (view === 'home') {
                renderHome(data); 
                window.history.pushState({ view: 'home', filter: data }, 'VercelMuvi - Inicio', '#home');
            } else if (view === 'about') {
                renderAbout();
                window.history.pushState({ view: 'about' }, 'VercelMuvi - Acerca de', '#about');
            }
        }

        // Manejador del botón de retroceso del navegador
        window.onpopstate = (event) => {
            if (event.state) {
                if (event.state.view === 'home') {
                    renderHome(event.state.filter || '');
                } else if (event.state.view === 'about') {
                    renderAbout();
                } else if (event.state.view === 'details') {
                    renderDetails(event.state.key);
                } else if (event.state.view === 'player') {
                    // Si el estado es del reproductor, el navegador ya restauró la URL.
                    // Para simplificar, asumimos que history.back() nos llevará al detalle correcto.
                }
            } else {
                renderHome(''); 
            }
        };

        // --- INICIALIZACIÓN ---

        window.onload = () => {
            loadData();

            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');

            const performSearch = () => {
                const query = searchInput.value;
                navigateTo('home', query);
            };

            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Evita el submit del formulario si existiera
                    performSearch();
                }
            });

            document.getElementById('nav-home').addEventListener('click', () => navigateTo('home'));
            document.getElementById('nav-about').addEventListener('click', () => navigateTo('about'));

            if (!history.state) {
                window.history.replaceState({ view: 'home', filter: '' }, 'VercelMuvi - Inicio', '#home');
            }
        };
    </script>
</body>
</html>