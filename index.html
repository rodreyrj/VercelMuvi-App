<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280, initial-scale=0.5"> 
    <title>VercelMuvi - Tu Plataforma de Streaming</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos generales oscuros para una apariencia moderna y elegante */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark Blue Gray */
        }
        /* Contenedor del reproductor: El "recuadro rectangular" grande, como quieres */
        .video-container {
            position: relative;
            width: 100%;
            /* Proporción 16:9 (o 56.25% de la anchura) para el recuadro de video */
            padding-bottom: 56.25%; 
            height: 0;
            overflow: hidden;
            background-color: #000; /* Fondo negro */
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        /* Estilo del iframe para ocupar todo el contenedor */
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body class="min-h-screen text-white">

    <header class="bg-gray-900 shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-col sm:flex-row justify-between items-center">
            <h1 class="text-3xl font-extrabold text-indigo-400 mb-4 sm:mb-0 cursor-pointer" id="nav-home">
                VercelMuvi
            </h1>
            
            <div class="flex items-center space-x-4 w-full sm:w-auto">
                
                <div class="relative flex-grow">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Buscar series o películas..." 
                        class="w-full sm:w-64 bg-gray-800 text-white rounded-full py-2 px-4 pl-10 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition"
                    >
                    <button id="search-button" class="absolute left-0 top-1/2 transform -translate-y-1/2 ml-3 text-gray-400 hover:text-indigo-400 p-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>

                <button 
                    id="nav-about" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-full transition duration-150 shadow-md whitespace-nowrap"
                >
                    Acerca de
                </button>
            </div>
        </div>
    </header>

    <div class="bg-gray-800 p-2 border-b border-gray-700">
        <div class="container mx-auto px-4">
            <span class="text-sm text-gray-400">VercelMuvi / <span id="current-title" class="text-indigo-300 font-medium">Inicio</span></span>
        </div>
    </div>

    <main id="content" class="min-h-[70vh]">
        </main>

    <footer class="bg-gray-900 p-4 text-center text-gray-500 mt-8">
        <p>&copy; 2025 VercelMuvi. Plataforma de contenido organizado.</p>
    </footer>

    <script>
        // --- CONFIGURACIÓN Y DATOS ---
        const DATA_URL = 'data.json'; 
        const WHATSAPP_NUMBER = '573001234567'; 
        const ADMIN_EMAIL = 'contacto@vercelmuvi.com'; 
        
        const MAX_INITIAL_CARDS = 5; 
        
        let groupedData = []; 
        let currentMaxCards = MAX_INITIAL_CARDS; 
        
        // --- LÓGICA DE PROCESAMIENTO DE DATOS ---
        async function fetchWithRetry(url, retries = 3) {
            let lastError = null; 
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return response;
                    }
                    lastError = `Status ${response.status}: La URL devolvió un error.`;
                    console.warn(`[VercelMuvi] Intento ${i + 1} fallido con status ${response.status}. Reintentando...`);
                } catch (error) {
                    lastError = `Error de red/seguridad: ${error.message}`;
                    console.warn(`[VercelMuvi] Intento ${i + 1} fallido por error de red:`, error);
                }
                if (i < retries - 1) {
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }
            throw new Error(`Fallo al cargar la URL después de ${retries} intentos. Último error: ${lastError || 'Desconocido.'}`);
        }

        function processJSONData(jsonData) {
            console.log("--- Diagnóstico JSON de VercelMuvi ---");
            if (!Array.isArray(jsonData)) {
                console.error("[JSON ERROR CRÍTICO] El archivo JSON no es un array de objetos. Debe empezar y terminar con corchetes `[]`.");
                return [];
            }

            const processedData = [];
            jsonData.forEach((item, index) => {
                const url = item.url ? String(item.url).trim() : '';
                const nombre = item.nombre ? String(item.nombre).trim() : '';
                const embed = item.embed ? String(item.embed).trim() : '';

                if (url && nombre && embed) {
                    processedData.push({
                        url: url,
                        nombre: nombre,
                        embed: embed,
                        portada: url 
                    });
                } else {
                    console.warn(`[JSON Diagnóstico] Objeto descartado en índice ${index} (datos incompletos en url, nombre o embed):`, item);
                }
            });
            console.log(`[JSON Diagnóstico] Total de objetos válidos procesados: ${processedData.length}`);
            console.log("-------------------------------------");
            return processedData;
        }

        function groupData(data) {
            const groups = {};

            data.forEach(item => {
                const key = item.portada; 

                if (!groups[key]) {
                    groups[key] = {
                        portada: key,
                        title: item.nombre.includes(' - ') ? item.nombre.split(' - ')[0].trim() : item.nombre.trim(), 
                        items: []
                    };
                }
                groups[key].items.push(item);
            });

            for (const key in groups) {
                groups[key].items.sort((a, b) => a.nombre.localeCompare(b.nombre));
            }

            return Object.values(groups).sort((a, b) => a.title.localeCompare(b.title));
        }

        window.showMoreCards = function() {
            currentMaxCards += MAX_INITIAL_CARDS; 
            renderHome(document.getElementById('search-input').value);
        }

        async function loadData() {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="flex flex-col items-center justify-center p-10 text-lg text-indigo-400">
                    <svg class="animate-spin h-8 w-8 mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Cargando contenido de VercelMuvi...
                    <p class="text-sm text-gray-400 mt-2">Revisa la consola (F12) para diagnósticos detallados.</p>
                </div>`;
            try {
                const response = await fetchWithRetry(DATA_URL);
                const jsonData = await response.json(); 
                const rawData = processJSONData(jsonData); 
                groupedData = groupData(rawData); 
                if (groupedData.length === 0) {
                     content.innerHTML = `<div class="text-center p-10 text-red-400">
                        <h2 class="text-xl font-bold mb-4">¡Falla de Carga de Datos!</h2>
                        <p>No se encontraron datos válidos. Asegúrate de que tu <code>data.json</code> no esté vacío y tenga el formato correcto.</p>
                    </div>`;
                    return;
                }
                renderHome(); 
            } catch (error) {
                console.error('[ERROR FATAL VercelMuvi] La carga de datos JSON falló completamente:', error);
                content.innerHTML = `<div class="text-center p-10 text-red-400">
                    <h2 class="text-xl font-bold mb-4">Error de Conexión/Formato JSON</h2>
                    <p>Fallo al cargar la URL o al procesar el archivo JSON después de varios intentos.</p>
                    <p class="text-sm text-gray-400 mt-2">Detalles: ${error.message}</p>
                </div>`;
            }
        }

        // --- FUNCIONES DE RENDERING (VISTAS) ---
        
        function clearContent() {
            document.getElementById('content').innerHTML = '';
        }

        window.renderHome = function(filterText = '') { 
            clearContent();
            document.getElementById('current-title').textContent = 'Inicio';
            
            const content = document.getElementById('content');
            const lowerCaseFilter = filterText.toLowerCase();

            const filteredGroups = groupedData.filter(group => 
                group.title.toLowerCase().includes(lowerCaseFilter) || 
                group.items.some(item => item.nombre.toLowerCase().includes(lowerCaseFilter))
            );

            const groupsToShow = filteredGroups.slice(0, currentMaxCards);
            const hasMoreCards = filteredGroups.length > currentMaxCards;
            
            const cardsHtml = groupsToShow.map(group => {
                const fallbackSrc = 'https://placehold.co/250x375/312e81/ffffff?text=VercelMuvi';
                
                return `
                    <div 
                        class="bg-gray-800 rounded-xl shadow-lg hover:shadow-2xl transition duration-300 ease-in-out cursor-pointer transform hover:-translate-y-1 overflow-hidden"
                        onclick="renderDetails('${group.portada.replace(/'/g, "\\'")}')"
                    >
                        <div class="relative w-full aspect-[2/3] bg-gray-900">
                            <img 
                                src="${group.portada}" 
                                alt="Portada de ${group.title}" 
                                class="w-full h-full object-cover transition duration-500 ease-in-out hover:opacity-75"
                                onerror="this.onerror=null; this.src='${fallbackSrc}';"
                            />
                            <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
                            <div class="absolute bottom-0 left-0 p-4">
                                <h3 class="text-xl font-bold text-white leading-tight">${group.title}</h3>
                                <p class="text-sm text-indigo-300">${group.items.length} ${group.items.length > 1 ? 'partes/caps' : 'parte/cap'}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            let moreButtonHtml = '';
            if (hasMoreCards) {
                moreButtonHtml = `
                    <div class="col-span-full mt-8 text-center">
                        <button 
                            onclick="showMoreCards()" 
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full transition duration-300 shadow-lg transform hover:scale-105"
                        >
                            Ver Más (${filteredGroups.length - currentMaxCards} más)
                        </button>
                    </div>
                `;
            }

            content.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <h2 class="text-3xl font-extrabold text-white mb-6">Contenido Agrupado</h2>
                    ${filteredGroups.length === 0 ? 
                        `<p class="text-white text-lg mt-10 text-center">No se encontraron resultados para "${filterText}".</p>` : 
                        `<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-6">
                            ${cardsHtml}
                            ${moreButtonHtml}
                        </div>`
                    }
                </div>
            `;
            document.getElementById('search-input').value = filterText;
        }

        // Vista de Detalles, Carga el primer capítulo en el reproductor incrustado
        window.renderDetails = function(portadaKey) { 
            clearContent();
            const group = groupedData.find(g => g.portada === portadaKey);

            if (!group || group.items.length === 0) {
                renderHome(); 
                return;
            }
            
            // Cargar el primer item por defecto para que el reproductor no esté vacío
            const defaultItem = group.items[0]; 
            
            document.getElementById('current-title').textContent = group.title;
            
            // Llama a la función que dibuja la vista y carga el reproductor
            renderDetailsAndPlayer(group, defaultItem);

            window.history.pushState({ view: 'details', key: portadaKey }, group.title, `#details/${encodeURIComponent(portadaKey)}`);
        }

        // Función para renderizar la vista de detalles Y el reproductor incrustado
        window.renderDetailsAndPlayer = function(group, currentItem) {
            const content = document.getElementById('content');
            
            let videoSource = currentItem.embed;

            // 1. Extraer la URL src si es un iframe completo
            if (currentItem.embed.toLowerCase().startsWith('<iframe')) {
                const match = currentItem.embed.match(/src=["'](.*?)["']/i);
                if (match && match[1]) {
                    videoSource = match[1];
                } 
            }

            // 2. CORRECCIÓN CLAVE PARA POWVIDEO (Eliminar el parámetro de tamaño: -954x562.html)
            videoSource = videoSource.replace(/-\d+x\d+\.html/i, '.html');

            // 3. APLICAR EL PARÁMETRO ANTI-CAPCHA (AutoPlay)
            if (!videoSource.includes('?')) {
                videoSource += '?auto_play=1'; 
            } else if (!videoSource.includes('auto_play')) {
                videoSource += '&auto_play=1';
            }
            
            
            // La lista de capítulos ahora llama a esta misma función para cambiar el video en el recuadro
            const partsList = group.items.map(item => `
                <li 
                    class="p-4 border-b border-gray-700 last:border-b-0 transition duration-150 cursor-pointer rounded-lg 
                    ${item.nombre === currentItem.nombre ? 'bg-indigo-600/50 text-white font-bold' : 'hover:bg-indigo-900/20'}"
                    onclick="renderDetailsAndPlayer(groupedData.find(g => g.portada === '${group.portada.replace(/'/g, "\\'")}') , 
                                                    groupedData.find(g => g.portada === '${group.portada.replace(/'/g, "\\'")}')
                                                               .items.find(i => i.nombre === '${item.nombre.replace(/'/g, "\\'")}') )"
                >
                    <span class="text-lg">${item.nombre}</span>
                    ${item.nombre === currentItem.nombre ? '<span class="text-sm text-white/70 block">Viendo ahora</span>' : ''}
                </li>
            `).join('');

            const fallbackSrc = 'https://placehold.co/300x450/312e81/ffffff?text=VercelMuvi';

            content.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <button onclick="navigateTo('home')" class="text-indigo-400 hover:text-indigo-300 mb-6 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                        Volver a Portadas
                    </button>
                    
                    <h1 class="text-3xl font-extrabold text-white mb-4">${group.title} - ${currentItem.nombre}</h1>

                    <div class="bg-gray-900 rounded-xl shadow-2xl mb-8 p-1">
                        
                        <div class="video-container">
                            <iframe 
                                src="${videoSource}" 
                                frameborder="0" 
                                allowfullscreen 
                                title="Reproductor de ${currentItem.nombre}"
                                // Se añade 'allow-top-navigation' que es CRÍTICO para que Powvideo cargue después del Captcha.
                                // Se elimina 'sandbox' para máxima compatibilidad con el reproductor de video.
                                allow="autoplay; fullscreen; encrypted-media; gyroscope; picture-in-picture; allow-top-navigation" 
                            ></iframe>
                        </div>
                    </div>
                    <div class="md:flex bg-gray-800/50 rounded-xl p-6 shadow-2xl">
                        
                        <div class="md:w-1/3 flex justify-center mb-6 md:mb-0 md:pr-8">
                            <img 
                                src="${group.portada}" 
                                alt="Portada de ${group.title}" 
                                class="rounded-xl w-full max-w-xs h-auto object-cover shadow-2xl"
                                onerror="this.onerror=null; this.src='${fallbackSrc}';"
                            />
                        </div>
                        
                        <div class="md:w-2/3">
                            <h2 class="text-3xl font-bold text-white mb-4">Lista de Capítulos</h2>
                            <p class="text-indigo-400 text-lg mb-6">${group.items.length} Partes o Capítulos Disponibles</p>
                            
                            <div class="bg-gray-900 rounded-lg shadow-inner max-h-96 overflow-y-auto">
                                <ul class="divide-y divide-gray-700">
                                    ${partsList}
                                </ul>
                            </div>
                        </div>
                    </div>
                    </div>
            `;
            // Actualiza el estado del historial
            window.history.replaceState({ view: 'player', groupKey: group.portada, itemKey: currentItem.nombre }, `${group.title} - ${currentItem.nombre}`, `#player/${encodeURIComponent(group.portada)}/${encodeURIComponent(currentItem.nombre)}`);
        }
        
        // --- FUNCIÓN DE NAVEGACIÓN (Acerca de, etc.) ---
        window.renderAbout = function() { 
            // ... (Sin cambios)
            clearContent();
            document.getElementById('current-title').textContent = 'Acerca de';
            
            const content = document.getElementById('content');
            const whatsappLink = `https://wa.me/${WHATSAPP_NUMBER}?text=Hola,%20me%20gustaría%20solicitar%20la%20siguiente%20serie%20o%20película...`;
            
            content.innerHTML = `
                <div class="container mx-auto px-4 py-8 max-w-2xl">
                    <div class="bg-gray-800 rounded-xl p-8 shadow-2xl">
                        <h1 class="text-4xl font-extrabold text-indigo-400 mb-6">Acerca de VercelMuvi</h1>
                        
                        <p class="text-gray-300 mb-8">
                            VercelMuvi es una plataforma moderna, elegante y organizada dedicada a ofrecerte el mejor contenido de series y películas agrupado de forma intuitiva por su portada. Nuestro objetivo es que encuentres lo que buscas rápidamente.
                        </p>

                        <div class="space-y-4 mb-10 border-t border-gray-700 pt-6">
                            <h2 class="text-2xl font-bold text-white">Información de Contacto</h2>
                            <div class="flex items-center text-gray-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                                    <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                                </svg>
                                <span class="font-medium">Correo del Gestor:</span> <a href="mailto:${ADMIN_EMAIL}" class="ml-2 text-indigo-300 hover:text-indigo-200 transition">${ADMIN_EMAIL}</a>
                            </div>
                            <div class="flex items-center text-gray-300">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-3 text-indigo-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.772-1.549a1 1 0 011.06-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" />
                                </svg>
                                <span class="font-medium">Número de Teléfono:</span> <span class="ml-2 text-white">${WHATSAPP_NUMBER}</span>
                            </div>
                        </div>

                        <a 
                            href="${whatsappLink}" 
                            target="_blank" 
                            class="mt-8 w-full flex items-center justify-center px-8 py-4 border border-transparent text-lg font-bold rounded-full shadow-lg text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-700/50 transition duration-150 transform hover:scale-[1.02]"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="mr-3">
                                <path d="M12.001 2c-5.522 0-10 4.477-10 10 0 3.033 1.34 5.762 3.493 7.61l-.678 2.017 2.083-.65 2.158.749 4.945-4.832c3.486-1.743 5.495-5.32 5.01-9.176-.485-3.856-3.882-6.843-7.893-6.843zm4.562 10.98c-.18.12-.392.18-.636.18h-.001c-.244 0-.466-.06-.677-.18s-.36-.28-.54-.42c-.18-.14-.36-.33-.48-.54s-.22-.48-.22-.72c0-.24.08-.48.22-.72s.3-.41.51-.59c.21-.18.42-.31.64-.39.22-.08.48-.12.78-.12h.001c.3 0 .56.04.78.12s.39.21.57.39c.18.18.3.37.38.6s.12.42.12.72c0 .24-.04.48-.12.72s-.21.46-.39.63z" fill="#FFF"/>
                            </svg>
                            Pedir Serie o Película
                        </a>
                    </div>
                </div>
            `;
        }
        
        // --- NAVEGACIÓN Y CONTROL DE ESTADO ---
        
        window.navigateTo = function(view, data = '') { 
            if (view === 'home') {
                currentMaxCards = MAX_INITIAL_CARDS; 
                renderHome(data); 
                window.history.pushState({ view: 'home', filter: data }, 'VercelMuvi - Inicio', '#home');
            } else if (view === 'about') {
                renderAbout();
                window.history.pushState({ view: 'about' }, 'VercelMuvi - Acerca de', '#about');
            }
        }
        
        window.onpopstate = (event) => {
            if (event.state) {
                if (event.state.view === 'home') {
                    renderHome(event.state.filter || '');
                } else if (event.state.view === 'about') {
                    renderAbout();
                } else if (event.state.view === 'details') {
                    renderDetails(event.state.key);
                } else if (event.state.view === 'player' && groupedData.length > 0) { 
                    const group = groupedData.find(g => g.portada === event.state.groupKey);
                    const item = group ? group.items.find(i => i.nombre === event.state.itemKey) : null;
                    if (group && item) {
                        renderDetailsAndPlayer(group, item);
                    } else {
                         renderHome(); 
                    }
                } else {
                    renderHome(); 
                }
            } else {
                navigateTo('home', ''); 
            }
        };

        // --- INICIALIZACIÓN ---
        
        window.onload = () => {
            loadData();

            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            
            const performSearch = () => {
                const query = searchInput.value;
                currentMaxCards = MAX_INITIAL_CARDS; 
                navigateTo('home', query);
            };

            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    performSearch();
                }
            });
            
            document.getElementById('nav-home').addEventListener('click', () => navigateTo('home'));
            document.getElementById('nav-about').addEventListener('click', () => navigateTo('about'));
            
            // Lógica para manejar la carga directa por URL (hash)
            if (location.hash.startsWith('#player/') && groupedData.length > 0) {
                 const parts = location.hash.split('/');
                 if (parts.length === 3) {
                    const groupKey = decodeURIComponent(parts[1]);
                    const itemKey = decodeURIComponent(parts[2]);
                    const group = groupedData.find(g => g.portada === groupKey);
                    const item = group ? group.items.find(i => i.nombre === itemKey) : null;
                    if (group && item) {
                        renderDetailsAndPlayer(group, item);
                        return;
                    }
                 }
            } else if (location.hash.startsWith('#details/')) {
                // ... (Cargar vista de detalles)
            } else if (location.hash === '#about') {
                // ... (Cargar vista de acerca de)
            } else {
                // loadData() llama a renderHome()
            }
        };
    </script>
</body>
</html>
